!** DGAMLN
REAL(DP) FUNCTION DGAMLN(Z,Ierr)
  !> Compute the logarithm of the Gamma function
  !***
  ! **Library:**   SLATEC
  !***
  ! **Category:**  C7A
  !***
  ! **Type:**      DOUBLE PRECISION (GAMLN-S, DGAMLN-D)
  !***
  ! **Keywords:**  LOGARITHM OF GAMMA FUNCTION
  !***
  ! **Author:**  Amos, D. E., (SNL)
  !***
  ! **Description:**
  !
  !               **** A DOUBLE PRECISION ROUTINE ****
  !         DGAMLN COMPUTES THE NATURAL LOG OF THE GAMMA FUNCTION FOR
  !         Z>0.  THE ASYMPTOTIC EXPANSION IS USED TO GENERATE VALUES
  !         GREATER THAN ZMIN WHICH ARE ADJUSTED BY THE RECURSION
  !         G(Z+1)=Z*G(Z) FOR Z<=ZMIN.  THE FUNCTION WAS MADE AS
  !         PORTABLE AS POSSIBLE BY COMPUTING ZMIN FROM THE NUMBER OF BASE
  !         10 DIGITS IN A WORD, RLN=MAX(-ALOG10(R1MACH(4)),0.5E-18)
  !         LIMITED TO 18 DIGITS OF (RELATIVE) ACCURACY.
  !
  !         SINCE INTEGER ARGUMENTS ARE COMMON, A TABLE LOOK UP ON 100
  !         VALUES IS USED FOR SPEED OF EXECUTION.
  !
  !     DESCRIPTION OF ARGUMENTS
  !
  !         INPUT      Z IS D0UBLE PRECISION
  !           Z      - ARGUMENT, Z>0.0D0
  !
  !         OUTPUT      DGAMLN IS DOUBLE PRECISION
  !           DGAMLN  - NATURAL LOG OF THE GAMMA FUNCTION AT Z/=0.0D0
  !           IERR    - ERROR FLAG
  !                     IERR=0, NORMAL RETURN, COMPUTATION COMPLETED
  !                     IERR=1, Z<=0.0D0,    NO COMPUTATION
  !
  !
  !***
  ! **References:**  COMPUTATION OF BESSEL FUNCTIONS OF COMPLEX ARGUMENT
  !                 BY D. E. AMOS, SAND83-0083, MAY, 1983.
  !***
  ! **Routines called:**  D1MACH, I1MACH

  !* REVISION HISTORY  (YYMMDD)
  !   830501  DATE WRITTEN
  !   830501  REVISION DATE from Version 3.2
  !   910415  Prologue converted to Version 4.0 format.  (BAB)
  !   920128  Category corrected.  (WRB)
  !   921215  DGAMLN defined for Z negative.  (WRB)
  USE service, ONLY : D1MACH, I1MACH
  REAL(DP) :: fln, fz, rln, s, tlg, trm, tst, t1, wdtol, Z, zdmy, zinc, zm, &
    zmin, zp, zsq
  INTEGER :: i, Ierr, i1m, k, mz, nz
  !           LNGAMMA(N), N=1,100
  REAL(DP), PARAMETER :: gln(100) = [ 0.00000000000000000E+00_DP, 0.00000000000000000E+00_DP, &
    6.93147180559945309E-01_DP, 1.79175946922805500E+00_DP, 3.17805383034794562E+00_DP, &
    4.78749174278204599E+00_DP, 6.57925121201010100E+00_DP, 8.52516136106541430E+00_DP, &
    1.06046029027452502E+01_DP, 1.28018274800814696E+01_DP, 1.51044125730755153E+01_DP, &
    1.75023078458738858E+01_DP, 1.99872144956618861E+01_DP, 2.25521638531234229E+01_DP, &
    2.51912211827386815E+01_DP, 2.78992713838408916E+01_DP, 3.06718601060806728E+01_DP, &
    3.35050734501368889E+01_DP, 3.63954452080330536E+01_DP, 3.93398841871994940E+01_DP, &
    4.23356164607534850E+01_DP, 4.53801388984769080E+01_DP, 4.84711813518352239E+01_DP, &
    5.16066755677643736E+01_DP, 5.47847293981123192E+01_DP, 5.80036052229805199E+01_DP, &
    6.12617017610020020E+01_DP, 6.45575386270063311E+01_DP, 6.78897431371815350E+01_DP, &
    7.12570389671680090E+01_DP, 7.46582363488301644E+01_DP, 7.80922235533153106E+01_DP, &
    8.15579594561150372E+01_DP, 8.50544670175815174E+01_DP, 8.85808275421976788E+01_DP, &
    9.21361756036870925E+01_DP, 9.57196945421432025E+01_DP, 9.93306124547874269E+01_DP, &
    1.02968198614513813E+02_DP, 1.06631760260643459E+02_DP, 1.10320639714757395E+02_DP, &
    1.14034211781461703E+02_DP, 1.17771881399745072E+02_DP, 1.21533081515438634E+02_DP, &
    1.25317271149356895E+02_DP, 1.29123933639127215E+02_DP, 1.32952575035616310E+02_DP, &
    1.36802722637326368E+02_DP, 1.40673923648234259E+02_DP, 1.44565743946344886E+02_DP, &
    1.48477766951773032E+02_DP, 1.52409592584497358E+02_DP, 1.56360836303078785E+02_DP, &
    1.60331128216630907E+02_DP, 1.64320112263195181E+02_DP, 1.68327445448427652E+02_DP, &
    1.72352797139162802E+02_DP, 1.76395848406997352E+02_DP, 1.80456291417543771E+02_DP, &
    1.84533828861449491E+02_DP, 1.88628173423671591E+02_DP, 1.92739047287844902E+02_DP, &
    1.96866181672889994E+02_DP, 2.01009316399281527E+02_DP, 2.05168199482641199E+02_DP, &
    2.09342586752536836E+02_DP, 2.13532241494563261E+02_DP, 2.17736934113954227E+02_DP, &
    2.21956441819130334E+02_DP, 2.26190548323727593E+02_DP, 2.30439043565776952E+02_DP, &
    2.34701723442818268E+02_DP, 2.38978389561834323E+02_DP, 2.43268849002982714E+02_DP, &
    2.47572914096186884E+02_DP, 2.51890402209723194E+02_DP, 2.56221135550009525E+02_DP, &
    2.60564940971863209E+02_DP, 2.64921649798552801E+02_DP, 2.69291097651019823E+02_DP, &
    2.73673124285693704E+02_DP, 2.78067573440366143E+02_DP, 2.82474292687630396E+02_DP, &
    2.86893133295426994E+02_DP, 2.91323950094270308E+02_DP, 2.95766601350760624E+02_DP, &
    3.00220948647014132E+02_DP, 3.04686856765668715E+02_DP, 3.09164193580146922E+02_DP, &
    3.13652829949879062E+02_DP, 3.18152639620209327E+02_DP, 3.22663499126726177E+02_DP, &
    3.27185287703775217E+02_DP, 3.31717887196928473E+02_DP, 3.36261181979198477E+02_DP, &
    3.40815058870799018E+02_DP, 3.45379407062266854E+02_DP, 3.49954118040770237E+02_DP, &
    3.54539085519440809E+02_DP, 3.59134205369575399E+02_DP ]
  !             COEFFICIENTS OF ASYMPTOTIC EXPANSION
  REAL(DP), PARAMETER :: cf(22) = [ 8.33333333333333333E-02_DP, -2.77777777777777778E-03_DP, &
    7.93650793650793651E-04_DP, -5.95238095238095238E-04_DP, 8.41750841750841751E-04_DP, &
    -1.91752691752691753E-03_DP, 6.41025641025641026E-03_DP, -2.95506535947712418E-02_DP, &
    1.79644372368830573E-01_DP, -1.39243221690590112E+00_DP, 1.34028640441683920E+01_DP, &
    -1.56848284626002017E+02_DP, 2.19310333333333333E+03_DP, -3.61087712537249894E+04_DP, &
    6.91472268851313067E+05_DP, -1.52382215394074162E+07_DP, 3.82900751391414141E+08_DP, &
    -1.08822660357843911E+10_DP, 3.47320283765002252E+11_DP, -1.23696021422692745E+13_DP, &
    4.88788064793079335E+14_DP, -2.13203339609193739E+16_DP ]
  !
  !             LN(2*PI)
  REAL(DP), PARAMETER :: con = 1.83787706640934548_DP
  !
  !* FIRST EXECUTABLE STATEMENT  DGAMLN
  Ierr = 0
  IF( Z<=0._DP ) THEN
    !
    !
    DGAMLN = D1MACH(2)
    Ierr = 1
    RETURN
  ELSE
    IF( Z<=101._DP ) THEN
      nz = INT( Z )
      fz = Z - nz
      IF( fz<=0._DP ) THEN
        IF( nz<=100 ) THEN
          DGAMLN = gln(nz)
          RETURN
        END IF
      END IF
    END IF
    wdtol = D1MACH(4)
    wdtol = MAX(wdtol,0.5E-18_DP)
    i1m = I1MACH(14)
    rln = D1MACH(5)*i1m
    fln = MIN(rln,20._DP)
    fln = MAX(fln,3._DP)
    fln = fln - 3._DP
    zm = 1.8000_DP + 0.3875_DP*fln
    mz = INT( zm ) + 1
    zmin = mz
    zdmy = Z
    zinc = 0._DP
    IF( Z<zmin ) THEN
      zinc = zmin - nz
      zdmy = Z + zinc
    END IF
    zp = 1._DP/zdmy
    t1 = cf(1)*zp
    s = t1
    IF( zp>=wdtol ) THEN
      zsq = zp*zp
      tst = t1*wdtol
      DO k = 2, 22
        zp = zp*zsq
        trm = cf(k)*zp
        IF( ABS(trm)<tst ) EXIT
        s = s + trm
      END DO
    END IF
    IF( zinc==0._DP ) THEN
      tlg = LOG(Z)
      DGAMLN = Z*(tlg-1._DP) + 0.5_DP*(con-tlg) + s
      RETURN
    END IF
  END IF
  zp = 1._DP
  nz = INT( zinc )
  DO i = 1, nz
    zp = zp*(Z+(i-1))
  END DO
  tlg = LOG(zdmy)
  DGAMLN = zdmy*(tlg-1._DP) - LOG(zp) + 0.5_DP*(con-tlg) + s
  RETURN
END FUNCTION DGAMLN
