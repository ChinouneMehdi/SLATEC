!** DPSI
REAL(DP) ELEMENTAL FUNCTION DPSI(X)
  !> Compute the Psi (or Digamma) function.
  !***
  ! **Library:**   SLATEC (FNLIB)
  !***
  ! **Category:**  C7C
  !***
  ! **Type:**      DOUBLE PRECISION (PSI-S, DPSI-D, CPSI-C)
  !***
  ! **Keywords:**  DIGAMMA FUNCTION, FNLIB, PSI FUNCTION, SPECIAL FUNCTIONS
  !***
  ! **Author:**  Fullerton, W., (LANL)
  !***
  ! **Description:**
  !
  ! DPSI calculates the double precision Psi (or Digamma) function for
  ! double precision argument X.  PSI(X) is the logarithmic derivative
  ! of the Gamma function of X.
  !
  ! Series for PSI        on the interval  0.          to  1.00000E+00
  !                                        with weighted error   5.79E-32
  !                                         log weighted error  31.24
  !                               significant figures required  30.93
  !                                    decimal places required  32.05
  !
  !
  ! Series for APSI       on the interval  0.          to  1.00000E-02
  !                                        with weighted error   7.75E-33
  !                                         log weighted error  32.11
  !                               significant figures required  28.88
  !                                    decimal places required  32.71
  !
  !***
  ! **References:**  (NONE)
  !***
  ! **Routines called:**  D1MACH, DCOT, DCSEVL, INITDS, XERMSG

  !* REVISION HISTORY  (YYMMDD)
  !   770601  DATE WRITTEN
  !   890531  Changed all specific intrinsics to generic.  (WRB)
  !   890911  Removed unnecessary intrinsics.  (WRB)
  !   890911  REVISION DATE from Version 3.2
  !   891214  Prologue converted to Version 4.0 format.  (BAB)
  !   900315  CALLs to XERROR changed to CALLs to XERMSG.  (THJ)
  !   900727  Added EXTERNAL statement.  (WRB)
  !   920618  Removed space from variable name.  (RWC, WRB)
  USE service, ONLY : D1MACH
  REAL(DP), INTENT(IN) :: X
  INTEGER :: i, n
  REAL(DP) :: aux, y
  INTEGER, PARAMETER :: ntpsi = 23, ntapsi = 6
  REAL(DP), PARAMETER :: xbig = 1._DP/SQRT(D1MACH(3)), dxrel = SQRT(D1MACH(4))
  REAL(DP), PARAMETER :: psics(42) = [ -.38057080835217921520437677667039E-1_DP, &
    +.49141539302938712748204699654277E+0_DP, -.56815747821244730242892064734081E-1_DP, &
    +.83578212259143131362775650747862E-2_DP, -.13332328579943425998079274172393E-2_DP, &
    +.22031328706930824892872397979521E-3_DP, -.37040238178456883592889086949229E-4_DP, &
    +.62837936548549898933651418717690E-5_DP, -.10712639085061849855283541747074E-5_DP, &
    +.18312839465484165805731589810378E-6_DP, -.31353509361808509869005779796885E-7_DP, &
    +.53728087762007766260471919143615E-8_DP, -.92116814159784275717880632624730E-9_DP, &
    +.15798126521481822782252884032823E-9_DP, -.27098646132380443065440589409707E-10_DP, &
    +.46487228599096834872947319529549E-11_DP, -.79752725638303689726504797772737E-12_DP, &
    +.13682723857476992249251053892838E-12_DP, -.23475156060658972717320677980719E-13_DP, &
    +.40276307155603541107907925006281E-14_DP, -.69102518531179037846547422974771E-15_DP, &
    +.11856047138863349552929139525768E-15_DP, -.20341689616261559308154210484223E-16_DP, &
    +.34900749686463043850374232932351E-17_DP, -.59880146934976711003011081393493E-18_DP, &
    +.10273801628080588258398005712213E-18_DP, -.17627049424561071368359260105386E-19_DP, &
    +.30243228018156920457454035490133E-20_DP, -.51889168302092313774286088874666E-21_DP, &
    +.89027730345845713905005887487999E-22_DP, -.15274742899426728392894971904000E-22_DP, &
    +.26207314798962083136358318079999E-23_DP, -.44964642738220696772598388053333E-24_DP, &
    +.77147129596345107028919364266666E-25_DP, -.13236354761887702968102638933333E-25_DP, &
    +.22709994362408300091277311999999E-26_DP, -.38964190215374115954491391999999E-27_DP, &
    +.66851981388855302310679893333333E-28_DP, -.11469986654920864872529919999999E-28_DP, &
    +.19679385886541405920515413333333E-29_DP, -.33764488189750979801907200000000E-30_DP, &
    +.57930703193214159246677333333333E-31_DP ]
  REAL(DP), PARAMETER :: apsics(16) = [ -.832710791069290760174456932269E-3_DP, &
    -.416251842192739352821627121990E-3_DP, +.103431560978741291174463193961E-6_DP, &
    -.121468184135904152987299556365E-9_DP, +.311369431998356155521240278178E-12_DP, &
    -.136461337193177041776516100945E-14_DP, +.902051751315416565130837974000E-17_DP, &
    -.831542997421591464829933635466E-19_DP, +.101224257073907254188479482666E-20_DP, &
    -.156270249435622507620478933333E-22_DP, +.296542716808903896133226666666E-24_DP, &
    -.674686886765702163741866666666E-26_DP, +.180345311697189904213333333333E-27_DP, &
    -.556901618245983607466666666666E-29_DP, +.195867922607736251733333333333E-30_DP, &
    -.775195892523335680000000000000E-32_DP ]
  REAL(DP), PARAMETER :: pi = 3.14159265358979323846264338327950_DP
  !* FIRST EXECUTABLE STATEMENT  DPSI
  ! ntpsi = INITDS(psics,0.1_SP*D1MACH(3))
  ! ntapsi = INITDS(apsics,0.1_SP*D1MACH(3))
  !
  y = ABS(X)
  !
  IF( y>10._DP ) THEN
    !
    ! DPSI(X) FOR ABS(X) > 10.0
    !
    aux = 0._DP
    IF( y<xbig ) aux = DCSEVL(2._DP*(10._DP/y)**2-1._DP,apsics(1:ntapsi))
    !
    IF( X<0._DP ) THEN
      DPSI = LOG(ABS(X)) - 0.5_DP/X + aux - pi*DCOT(pi*X)
    ELSE
      DPSI = LOG(X) - 0.5_DP/X + aux
    END IF
    RETURN
  ELSE
    !
    ! DPSI(X) FOR ABS(X) <= 2
    !
    n = INT( X )
    IF( X<0._DP ) n = n - 1
    y = X - n
    n = n - 1
    DPSI = DCSEVL(2._DP*y-1._DP,psics(1:ntpsi))
    IF( n==0 ) RETURN
    !
    IF( n<=0 ) THEN
      !
      n = -n
      IF( X==0._DP ) ERROR STOP 'DPSI : X IS 0'
      IF( X<0._DP .AND. X+n-2==0._DP ) ERROR STOP 'DPSI : X IS A NEGATIVE INTEGER'
      ! IF( X<(-0.5_DP) .AND. ABS((X-AINT(X-0.5_DP))/X)<dxrel )&
        ! CALL XERMSG('DPSI','ANSWER LT HALF PRECISION BECAUSE X TOO NEAR NEGATIVE INTEGER'
      !
      DO i = 1, n
        DPSI = DPSI - 1._DP/(X+i-1)
      END DO
      RETURN
    END IF
  END IF
  !
  ! DPSI(X) FOR X >= 2.0 AND X <= 10.0
  !
  DO i = 1, n
    DPSI = DPSI + 1._DP/(y+i)
  END DO

  RETURN
END FUNCTION DPSI